
@{
    ViewBag.Title = "Verification Of DPO";
}
<div class="row text-sm">
    <div class="col-md-12" style="margin-top:-15px">
        <div class="card card-navy card-tabs">
            <div class="card-header p-0 pt-1 border-bottom-0">
                <ul class="nav nav-tabs" id="custom-tabs-two-tab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="custom-tabs-one-verified-tab" data-toggle="pill" href="#custom-tabs-one-verified" role="tab" aria-controls="custom-tabs-one-verified" aria-selected="true">Verified DPO</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link hide" id="custom-tabs-two-verification-tab" data-toggle="pill" href="#custom-tabs-two-verification" role="tab" aria-controls="custom-tabs-two-verification" aria-selected="true">Verification of DPO</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                @Html.AntiForgeryToken()
                <div class="tab-content" id="custom-tabs-two-tabContent">
                    <div class="tab-pane fade show active" id="custom-tabs-one-verified" role="tabpanel" aria-labelledby="custom-tabs-one-verified">
                        <div class="row" style="margin-top:-15px">
                            <div class="col-md-12">
                                <div class="card shadow">
                                    <div class="card-header">
                                        <div class="row tabHead">
                                            <div class="col-6">
                                                <h5>Search By:</h5>
                                            </div>
                                            <div class="col-6">
                                                <button type="button" id="btnAddVerification" class="btn btn-sm btn-flat btn-outline-primary float-right">
                                                    <i class="fas fa-plus">Verification of DPO</i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="row mt-1">
                                            <div class="col-md-3">
                                                <label class="control-label font-weight-bold" for="txtRequisitionNumForVerified">Req Num.</label>
                                                <input type="text" name="txtRequisitionNumForVerified" id="txtRequisitionNumForVerified" class="form-control form-control-sm" placeholder="Search By Req Num" />
                                            </div>
                                            <div class="col-md-2">
                                                <label class="control-label font-weight-bold" for="ddlDistrictForVerified">District</label>
                                                @Html.DropDownList("ddlDistrictForVerified", (IEnumerable<SelectListItem>)ViewBag.ddlDistrict, "---Select District---", new { @class = "form-control form-control-sm" })
                                            </div>
                                            <div class="col-md-2">
                                                <label class="control-label font-weight-bold" for="ddlZoneForVerified">Zone</label>
                                                <select class="form-control form-control-sm" id="ddlZoneForVerified">
                                                    <option value="">---Select Zone---</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="control-label font-weight-bold" for="ddlDealerForVerified">Dealer</label>
                                                <select class="form-control form-control-sm" id="ddlDealerForVerified">
                                                    <option value="">---Select Dealer---</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="control-label font-weight-bold" for="ddlSRForVerified">Sales Person</label>
                                                <select class="form-control form-control-sm" id="ddlSRForVerified">
                                                    <option value="">---Select SR---</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-2">
                                                <label class="control-label font-weight-bold" for="dptFromDateForVerified">From Date</label>
                                                <div class="input-group input-group-sm ">
                                                    <input type="text" class="form-control form-control-sm date-datePicker ctrl-changed" id="dptFromDateForVerified" />
                                                    <div class="input-group-prepend cursor-pointer remove-list-date dptFromDate" style="cursor:pointer">
                                                        <span class="input-group-text">&#10008;</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="control-label font-weight-bold" for="dptToDateForVerified">To Date</label>
                                                <div class="input-group input-group-sm ">
                                                    <input type="text" class="form-control form-control-sm date-datePicker ctrl-changed" id="dptToDateForVerified" />
                                                    <div class="input-group-prepend remove-list-date dptToDate" style="cursor:pointer">
                                                        <span class="input-group-text">&#10008;</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12" style="margin-top:-10px">
                                <div class="card shadow">
                                    <div class="card-body">
                                        <div class="col-md-12" id="dataContainer1">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade show" id="custom-tabs-two-verification" role="tabpanel" aria-labelledby="custom-tabs-two-verification">
                        <div class="row" style="margin-top:-15px">
                            <div class="col-md-12">
                                <div class="card shadow">
                                    <div class="card-header">
                                        <div class="row tabHead">
                                            <div class="col-3">
                                                <a href="#" class="btn btn-sm btn-flat btn-info" title="Back To List" onclick="redirectToAnotherTab('#custom-tabs-one-verified-tab')"><i class="fas fa-arrow-circle-left"></i></a>
                                            </div>
                                            <div class="col-6 text-center">
                                                <h5 class="text-bold">Verification Of DPO</h5>
                                            </div>
                                            <div class="col-3">
                                            </div>
                                        </div>
                                        <div class="row mt-1">
                                            <div class="col-md-3">
                                                <label class="control-label font-weight-bold" for="txtRequisitionNumForVerfication">Req Num.</label>
                                                <input type="text" name="txtRequisitionNumForVerfication" id="txtRequisitionNumForVerfication" class="form-control form-control-sm" placeholder="Search By Req Num" />
                                            </div>
                                            <div class="col-md-2">
                                                <label class="control-label font-weight-bold" for="ddlDistrictForVerification">District</label>
                                                @Html.DropDownList("ddlDistrictForVerification", (IEnumerable<SelectListItem>)ViewBag.ddlDistrict, "---Select District---", new { @class = "form-control form-control-sm" })
                                            </div>
                                            <div class="col-md-2">
                                                <label class="control-label font-weight-bold" for="ddlZoneForVerification">Zone</label>
                                                <select class="form-control form-control-sm" id="ddlZoneForVerification">
                                                    <option value="">---Select Zone---</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="control-label font-weight-bold" for="ddlDealerForVerification">Dealer</label>
                                                <select class="form-control form-control-sm" id="ddlDealerForVerification">
                                                    <option value="">---Select Dealer---</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="control-label font-weight-bold" for="ddlSRForVerification">Sales Person</label>
                                                <select class="form-control form-control-sm" id="ddlSRForVerification">
                                                    <option value="">---Select SR---</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-2">
                                                <label class="control-label font-weight-bold" for="dptFromDateForVerification">From Date</label>
                                                <div class="input-group input-group-sm ">
                                                    <input type="text" class="form-control form-control-sm date-datePicker ctrl-changed" id="dptFromDateForVerification" />
                                                    <div class="input-group-prepend cursor-pointer remove-date dptFromDate" style="cursor:pointer">
                                                        <span class="input-group-text">&#10008;</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="control-label font-weight-bold" for="dptToDateForVerification">To Date</label>
                                                <div class="input-group input-group-sm ">
                                                    <input type="text" class="form-control form-control-sm date-datePicker ctrl-changed" id="dptToDateForVerification" />
                                                    <div class="input-group-prepend remove-date dptToDate" style="cursor:pointer">
                                                        <span class="input-group-text">&#10008;</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="control-label font-weight-bold" style="visibility:hidden">Submit</label>
                                                <div class="clearfix">
                                                    <button class="btn btn-flat btn-sm btn-primary float-left" title="Submit" id="btnSubmit">
                                                        <i class="fas fa-paper-plane"></i> Submit..
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12" style="margin-top:-10px">
                                <div class="card shadow">
                                    <div class="card-body">
                                        <div class="col-md-12" id="dataContainer2">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script type="text/javascript">
        var txtRequisitionNumForVerified = $("#txtRequisitionNumForVerified");
        var ddlDistrictForVerified = $("#ddlDistrictForVerified");
        var ddlZoneForVerified = $("#ddlZoneForVerified");
        var ddlDealerForVerified = $("#ddlDealerForVerified");
        var ddlSRForVerified = $("#ddlSRForVerified");
        var dptFromDateForVerified = $("#dptFromDateForVerified");
        var dptToDateForVerified = $("#dptToDateForVerified");

        var txtRequisitionNumForVerification = $("#txtRequisitionNumForVerfication");
        var ddlDistrictForVerification = $("#ddlDistrictForVerification");
        var ddlZoneForVerification = $("#ddlZoneForVerification");
        var ddlDealerForVerification = $("#ddlDealerForVerification");
        var ddlSRForVerification = $("#ddlSRForVerification");
        var dptFromDateForVerification = $("#dptFromDateForVerification");
        var dptToDateForVerification = $("#dptToDateForVerification");
        var count = 0;

        $(document).ready(function () {
            $('.select2').select2();
            //Initialize Select2 Elements
            $('.select2bs4').select2({
                theme: 'bootstrap4'
            });
            dptFromDateForVerification.prop('readonly', true);
            dptToDateForVerification.prop('readonly', true);
            dptFromDateForVerification.css("background-color", "#fff");
            dptToDateForVerification.css("background-color", "#fff");
            $('#dptFromDateForVerification').datepicker({
                format: "dd MM yyyy",
                orientation: "bottom auto",
                todayHighlight: true
            }).on('change', function () {
                $('.datepicker').hide();
            });
            $('#dptToDateForVerification').datepicker({
                format: "dd MM yyyy",
                orientation: "bottom auto",
                todayHighlight: true
            }).on('change', function () {
                $('.datepicker').hide();
            });

            dptFromDateForVerified.prop('readonly', true);
            dptToDateForVerified.prop('readonly', true);
            dptFromDateForVerified.css("background-color", "#fff");
            dptToDateForVerified.css("background-color", "#fff");
            $('#dptFromDateForVerified').datepicker({
                format: "dd MM yyyy",
                orientation: "bottom auto",
                todayHighlight: true
            }).on('change', function () {
                $('.datepicker').hide();
            });
            $('#dptToDateForVerified').datepicker({
                format: "dd MM yyyy",
                orientation: "bottom auto",
                todayHighlight: true
            }).on('change', function () {
                $('.datepicker').hide();
            });
            loadDataInitializer();
        })

        function loadDataInitializer() {
            loadVerifiedDPO();
            loadUnVerifiedDPO();
        }

        //#region Verified DPO
        $(document).on('click', 'div.remove-list-date', function () {
            if ($(this).hasClass("dptToDate")) {
                if (dptToDateForVerified.val() !== '') {
                    dptToDateForVerified.val('');
                    loadVerifiedDPO();
                }
            }
            if ($(this).hasClass("dptFromDate")) {
                if (dptFromDateForVerified.val() !== '') {
                    dptFromDateForVerified.val('');
                    loadVerifiedDPO();
                }
            }
        })

        dptFromDateForVerified.change(function () {
            loadVerifiedDPO();
        })

        dptToDateForVerified.change(function () {
            loadVerifiedDPO();
        })

        function loadVerifiedDPO() {
            var data = { flag: "verified", refNum: $.trim(txtRequisitionNumForVerified.val()), dealerId: TryParseInt(ddlDealerForVerified.val(), 0), districtId: TryParseInt(ddlDistrictForVerified.val(), 0), zoneId: TryParseInt(ddlZoneForVerified.val(), 0), fromDate:dptFromDateForVerified.val(),toDate:dptToDateForVerified.val() };
            $.when(getReqWithData(dataType.html, type.get, '/SalesAndDistribution/VerificationOfDPO', data)).then(function (res, status) {
                if (status === "success") {
                    $("#dataContainer1").fadeOut('500', function () {
                        $("#dataContainer1").empty();
                        $("#dataContainer1").append(res).fadeIn('500');
                    });
                }
            }).fail(function (error) {
                consoleLog(error);
            })
        }

        txtRequisitionNumForVerified.keyup(function () {
            loadVerifiedDPO();
        })

        ddlDistrictForVerified.change(function () {
            clearDropdown("ddlZoneForVerified");
            clearDropdown("ddlDealerForVerified");
            clearDropdown("ddlSRForVerified");
            if (ddlDistrictForVerified.val() != "") {
                var data = JSON.stringify({ districtId: ddlDistrictForVerified.val() });
                LoadDropDown('/Common/GetZonesByDistrict', type.post, ddlZoneForVerified, data);
                LoadDropDown('/Common/GetDealerByDistrict', type.post, ddlDealerForVerified, data);
                LoadDropDown('/Common/GetSRByDistrict', type.post, ddlSRForVerified, data);
            }
            loadVerifiedDPO();
        })

        ddlZoneForVerified.change(function () {
            clearDropdown("ddlDealerForVerified");
            clearDropdown("ddlSRForVerified");
            if (ddlZoneForVerified.val() != "") {
                var data = JSON.stringify({ zoneId: ddlZoneForVerified.val() });
                LoadDropDown('/Common/GetDealerByZone', type.post, ddlDealerForVerified, data);
                LoadDropDown('/Common/GetSRByZone', type.post, ddlSRForVerified, data);
            }
            loadVerifiedDPO();
        })

        ddlDealerForVerified.change(function () {
            loadVerifiedDPO();
        })

        ddlSRForVerified.change(function () {
            loadVerifiedDPO();
        })
        //endregion

        //#region Verification Of DPO
        $("#btnAddVerification").click(function (e) {
            e.preventDefault();
            $("#custom-tabs-one-verified-tab").addClass("hide");
            $("#custom-tabs-two-verification-tab").removeClass("hide");
            $("#custom-tabs-two-verification-tab").trigger("click");
        })
        $(document).on('click', 'div.remove-date', function () {
            if ($(this).hasClass("dptToDate")) {
                if (dptToDateForReqList.val() !== '') {
                    dptToDateForReqList.val('');
                    loadUnVerifiedDPO();
                }
            }
            if ($(this).hasClass("dptFromDate")) {
                if (dptFromDateForVerification.val() !== '') {
                    dptFromDateForVerification.val('');
                    loadUnVerifiedDPO();
                }
            }
        })

        ddlDistrictForVerification.change(function () {
            clearDropdown("ddlZoneForVerification");
            clearDropdown("ddlDealerForVerification");
            clearDropdown("ddlSRForVerification");
            if (ddlDistrictForVerification.val() != "") {
                var data = JSON.stringify({ districtId: ddlDistrictForVerification.val() });
                LoadDropDown('/Common/GetZonesByDistrict', type.post, ddlZoneForVerification, data);
                LoadDropDown('/Common/GetDealerByDistrict', type.post, ddlDealerForVerification, data);
                LoadDropDown('/Common/GetSRByDistrict', type.post, ddlSRForVerification, data);
            }
            loadUnVerifiedDPO();
        })

        ddlSRForVerification.change(function () {
            loadUnVerifiedDPO();
        })

        ddlDealerForVerification.change(function () {
            loadUnVerifiedDPO();
        })

        ddlZoneForVerification.change(function () {
            clearDropdown("ddlDealerForVerification");
            clearDropdown("ddlSRForVerification");
            if (ddlZoneForVerification.val() != "") {
                var data = JSON.stringify({ zoneId: ddlZoneForVerification.val() });
                LoadDropDown('/Common/GetDealerByZone', type.post, ddlDealerForVerification, data);
                LoadDropDown('/Common/GetSRByZone', type.post, ddlSRForVerification, data);
            }
            loadUnVerifiedDPO();
        })

        dptFromDateForVerification.change(function () {
            loadUnVerifiedDPO();
        })

        dptToDateForVerification.change(function () {
            loadUnVerifiedDPO();
        })

        function loadUnVerifiedDPO() {
            var data = { flag: "unverified", refNum: $.trim(txtRequisitionNumForVerification.val()), dealerId: TryParseInt(ddlDealerForVerification.val(), 0), districtId: TryParseInt(ddlDistrictForVerification.val(), 0), zoneId: TryParseInt(ddlZoneForVerification.val(), 0), fromDate: dptFromDateForVerification.val(), toDate: dptToDateForVerification.val() };
            $.when(getReqWithData(dataType.html, type.get, '/SalesAndDistribution/VerificationOfDPO', data)).then(function (res, status) {
                if (status === "success") {
                    $("#dataContainer2").fadeOut('500', function () {
                        $("#dataContainer2").empty();
                        $("#dataContainer2").append(res).fadeIn('500');
                    });
                }
            }).fail(function (error) {
                consoleLog(error);
            })
        }

        $(document).on('change', 'input[name="chkAll"]', function () {
            var isChecked = $('input[name="chkAll"]').is(":checked");
            $('input[name="chkItem"]').prop("checked", isChecked);
            if (isChecked) {
                count = $(".tblUnverifiedDPO tbody tr").length;
            }
            else {
                count = 0;
            }
        })

        $(document).on('change', 'input[name="chkItem"]', function () {
            count = 0;
            $.each($(".tblUnverifiedDPO tbody tr"), function (index, item) {
                if ($(this).children('td').eq(0).children('input[name="chkItem"]').is(":checked")) {
                    count++;
                }
            });
            var allChecked = $(".tblUnverifiedDPO tbody tr").length == count;
            $('input[name="chkAll"]').prop("checked", allChecked);
        })

        txtRequisitionNumForVerification.keyup(function () {
            loadUnVerifiedDPO();
        })

        function validateVerification() {
            var isValid = true;
            count = 0;
            $.each($(".tblUnverifiedDPO tbody tr"), function (index, item) {
                if ($(this).children('td').eq(0).children('input[name="chkItem"]').is(":checked")) {
                    count++;
                }
            });
            if (count == 0) {
                isValid = false;
            }
            return isValid;
        }

        $("#btnSubmit").click(function (e) {
            e.preventDefault();
            if (validateVerification()) {
                bootbox.confirm("Are you sure you want to Verified this DPO?", function (result) {
                    if (result) {
                        disable("#btnSubmit")
                        var data = JSON.stringify({ id: fnGetSelectedDPO() });
                        //consoleLog(data);
                        //return;
                        $.when(postReqWithToken(dataType.applicationJson, dataType.json, type.post, '/SalesAndDistribution/SaveVerifiedDPO', data, getToken())).then(function (res, status) {
                            if (status === "success" && res === true) {
                                toastrSuccessAlert(execuStatus.successSave)
                                $("#custom-tabs-two-verification-tab").addClass("hide");
                                redirectToAnotherTab("#custom-tabs-one-verified-tab");
                                loadUnVerifiedDPO();
                            }
                            else {
                                toastrErrorAlert(execuStatus.fail);
                            }
                            enable("#btnSubmit")
                        }).fail(function (error) {
                            consoleLog(error);
                            toastrErrorAlert(execuStatus.fail);
                            enable("#btnSubmit");
                        })
                    }
                })
            }
        })

        function redirectToAnotherTab(tabId) {
            $(tabId).removeClass("hide");
            $(tabId).trigger("click");
            if (tabId == "#custom-tabs-one-verified-tab") {
                $("#custom-tabs-two-verification-tab").addClass("hide");
            }
        }

        function fnGetSelectedDPO() {
            var dpo = [];
            $.each($(".tblUnverifiedDPO tbody tr"), function (index, item) {
                if ($(this).children('td').eq(0).children('input[name="chkItem"]').is(":checked")) {
                    var id = $(this).children('td').eq(2).attr("data-val");
                    dpo.push(id);
                }
            })
            return dpo;
        }

            //#endregion
    </script>
}