
@{
    ViewBag.Title = "Stock Transfer";
    string tab = ViewBag.tab == null ? "" : ViewBag.tab;
}

<div class="row">
    <div class="col-md-12">
        <div class="card shadow card-primary card-outline card-tabs" style="margin-top:-20px">
            <div class="card-header p-0 pt-1 border-bottom-0 text-sm">
                <ul class="nav nav-tabs" id="custom-tabs-two-tab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="custom-tabs-two-stockTransferBToB-tab" data-toggle="pill" href="#custom-tabs-two-stockTransferBToB" role="tab" aria-controls="custom-tabs-two-stockTransferBToB" aria-selected="true">Parts Reqution For Branch</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="custom-tabs-two-stockTransferMToM-tab" data-toggle="pill" href="#custom-tabs-two-stockTransferMToM" role="tab" aria-controls="custom-tabs-two-stockTransferMToM" aria-selected="true">Stock Transfer M-M</a>
                    </li>
                </ul>
            </div>
            <div class="card-body shadow">
                <div class="tab-content" id="custom-tabs-two-tabContent">
                    @Html.AntiForgeryToken()
                    <div class="tab-pane fade show active" id="custom-tabs-two-stockTransferBToB" role="tabpanel" aria-labelledby="custom-tabs-two-stockTransferBToB-tab">
                        <div class="row" style="margin-top:-15px">
                            <div class="col-md-12">
                                <div class="card card-gray shadow">
                                    <div class="card-header">
                                        <div class="row">
                                            <div class="col-md-3">
                                            </div>
                                            <div class="col-md-6">
                                                <h5 class="text-center text-bold">
                                                    Parts Requsition List For Branch
                                                </h5>
                                            </div>
                                            <div class="col-md-3">
                                                <a href="/Configuration/CreateStockTransfer" style="background-color:darkblue" class="btn btn-outline-primary btn-sm float-lg-right" id="btnAddNew"><i class="fa fa-plus"></i> Requsition</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12" style="margin-top:-15px">
                                <div class="card shadow card-navy">
                                    <div class="card-body text-sm">
                                        <div class="row text-sm">
                                            <div class="col-md-3 hide">
                                                <label for="ddlServicesWarehouse" class="control-label font-weight-bold">ServicesWarehouse Name</label>
                                                @Html.DropDownList("ddlServicesWarehouse", (IEnumerable<SelectListItem>)ViewBag.ddlServicesWarehouse,new { @class = "form-control form-control-sm" })
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12" style="margin-top:-10px">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-12 text-sm" id="dataContainer">
                                                @{Html.RenderAction("TransferInfoList", new { @flag = "StockTranferB-B" });}
                                                @*@{Html.RenderAction("StockTransferInfoPartialList");}*@
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade show" id="custom-tabs-two-stockTransferMToM" role="tabpanel" aria-labelledby="custom-tabs-two-stockTransferMToM-tab">
                        <div class="row" style="margin-top:-15px">
                            <div class="col-md-12">
                                <div class="card card-gray shadow">
                                    <div class="card-header">
                                        <div class="row">
                                            <div class="col-md-3">
                                            </div>
                                            <div class="col-md-6">
                                                <h5 class="text-center text-bold">
                                                    Parts Transfer List
                                                </h5>
                                            </div>
                                            <div class="col-md-3">
                                                <a href="/Configuration/CreateStockTransferModelToModel" style="background-color:darkblue" class="btn btn-outline-primary btn-sm float-lg-right" id="btnM-M"><i class="fa fa-plus"></i> Stock Transfer</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12" style="margin-top:-15px">
                                <div class="card shadow card-navy">
                                    <div class="card-body text-sm">
                                        <div class="row text-sm">
                                            <div class="col-md-3 hide">
                                                <label for="ddlServicesWarehouseMM" class="control-label font-weight-bold">ServicesWarehouse Name</label>
                                                @Html.DropDownList("ddlServicesWarehouseMM", (IEnumerable<SelectListItem>)ViewBag.ddlServicesWarehouse, new { @class = "form-control form-control-sm" })
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12" style="margin-top:-10px">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-12 text-sm" id="dataContainer2">
                                                @{Html.RenderAction("TransferInfoList", new { @flag = "StockTranferM-M" });}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="modal fade" id="modalTransferDetails" role="dialog" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header alert-secondary">
                    <input type="hidden" id="hdfTransferInfoId" />
                    <input type="hidden" id="hdfRowIndex" />
                    <h4 id="modalHeading" class="modal-title">Requsition Details</h4>
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body" id="dataContainer1">

                </div>
            </div>
        </div>
    </div>
</div>

@section scripts{
<script type="text/javascript">
        //Stock Transfer B-B
        var ddlServicesWarehouse = $("#ddlServicesWarehouse");
        var hdfTransferInfoId = $("#hdfTransferInfoId");

        $(document).ready(function () {
            if ('@tab' == "StockTransferMM") {
                $("#custom-tabs-two-stockTransferMToM-tab").trigger('click');
            }
        })
        ddlServicesWarehouse.change(function () {
            LoadDataTable();
        })
        function LoadDataTable() {
            var data = { flag: "StockTranferB-B", sWerehouseId: TryParseInt(ddlServicesWarehouse.val(), 0) };
            console.log(data);
            $.when(getReqWithData('html', 'GET', '/Configuration/StockTransferInfoPartialList', data)).then(function (res, status) {
                console.log(status);
                if (status === "success") {
                    $("#dataContainer").fadeOut('500', function () {
                        $("#dataContainer").empty();
                        $("#dataContainer").append(res).fadeIn('500');
                    });
                }
            }).fail(function (error) {
                console.log(error);
            })
            pageNo = 1;
        }

        $(document).on('click', 'a.data-item-details', function (e) {
            e.preventDefault();
            hdfTransferInfoId.val("0")
            var id = $(this).attr("data-item-details");
            hdfTransferInfoId.val(id);
            $.when(getReqWithData('html', type.get, '/Configuration/TransferStockDetails', { transferId: id })).then(function (res, status) {
                if (status === "success") {
                    $("#dataContainer1").empty();
                    $("#dataContainer1").append(res);
                    $("#modalTransferDetails").modal("toggle");
                }
            }).fail(function (error) {
                console.log(error);
            })
        })

        // accept and Stock-In Warehouse Update Status
    $(document).on("click", ".btnAccepted", function (e) {
        e.preventDefault();
        $(".error").addClass("hide");
        bootbox.confirm("Are you sure you want to save?", function (result) {
            if (result) {
                var details = []; details.length = 0;
                $.each($("#tblTransferStockDetails tbody tr"), function (index, item) {
                    var tds = $(this).children('td');
                    var infoId = tds.eq('1').html();
                    var detId = tds.eq('2').html();
                    var model = tds.eq('3').html();
                    var partsId = tds.eq('4').html();
                    var issuQty = tds.eq('8').html();

                    details.push({
                        TransferInfoId: TryParseInt(infoId, 0),
                        TransferDetailId: TryParseInt(detId, 0),
                        DescriptionId: TryParseInt(model,0),
                        PartsId: TryParseInt(partsId, 0),
                        IssueQty: TryParseInt(issuQty, 0),
                    })
                });
                var data = JSON.stringify({ details: details });
                console.log("Receive Stock Data");
                //return console.log(data);
                $.when(postReqWithToken(dataType.applicationJson, dataType.json, 'POST', '/Configuration/ReceiveStockAndUpdateStatus', data, getToken())).then(function (res, status) {
                            console.log(res);
                            console.log(status);
                            if (res == true) {
                                $('.toastrDefaultSuccess').trigger('click');
                                setTimeout(function () {
                                    redirectPage('@Url.Action("TransferInfoList")');
                                }, 1000);
                                $("#modalTransferDetails").modal("toggle").toggle("fast");
                                LoadDataTable();
                            }
                            else {
                                $('.toastrDefaultError').trigger('click');
                            }
                        }).fail(function (error) {
                            consoleLog(error)
                        })
            }
        })
    })

        function fnTransferStateChange(id, swarehouse, status) {
            var data = JSON.stringify({ transferId: id, swarehouse: swarehouse, status: status });
            $.when(postReqWithToken(dataType.applicationJson, dataType.json, type.post, '/Configuration/SaveTranferStockStatus', data, getToken())).then(function (res, status) {
                if (res === true && status === "success") {
                    $("#modalTransferDetails").modal("toggle").toggle("fast");
                    hdfTransferInfoId.val('0');
                    $('.toastrReqSuccess').trigger('click');
                    $("#dataContainer1").empty();
                    setTimeout(function () {
                        LoadDataTable();
                    }, 1500);
                }
            }).fail(function (error) {
                console.log(error);
            })
        }

        //Stock Transfer M-M

        var ddlServicesWarehouseMM = $("#ddlServicesWarehouseMM");

        ddlServicesWarehouseMM.change(function () {
            LoadDataTableMM();
        })
        function LoadDataTableMM() {
            var data = { flag: "StockTranferM-M", sWerehouseId: TryParseInt(ddlServicesWarehouseMM.val(), 0) };

            $.when(getReqWithData('html', 'GET', '/Configuration/TransferInfoList', data)).then(function (res, status) {
                console.log(status);
                if (status === "success") {
                    $("#dataContainer2").fadeOut('500', function () {
                        $("#dataContainer2").empty();
                        $("#dataContainer2").append(res).fadeIn('500');
                    });
                }
            }).fail(function (error) {
                console.log(error);
            })
            pageNo = 1;
        }
        $(document).on('click', 'a.data-item-MM-details', function (e) {
            e.preventDefault();
            hdfTransferInfoId.val("0")
            var id = $(this).attr("data-item-MM-details");
            hdfTransferInfoId.val(id);
            $.when(getReqWithData('html', type.get, '/Configuration/StockTransferMMDetails', { transferId: id })).then(function (res, status) {
                if (status === "success") {
                    $("#dataContainer1").empty();
                    $("#dataContainer1").append(res);
                    $("#modalTransferDetails").modal("toggle");
                }
            }).fail(function (error) {
                console.log(error);
            })
        })
</script>
}
