@{
    ViewBag.Title = "Faulty Stock Info";
    //var privilege = (ERPBO.Common.UserPrivilege)ViewBag.UserPrivilege;
}   
<div class="row">
    <div class="col-md-12">
        @Html.AntiForgeryToken()
        <div class="card card-primary card-outline card-tabs">
            <div class="card-header p-0 pt-1 border-bottom-0">
                <ul class="nav nav-tabs" id="custom-tabs-two-tab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="custom-tabs-two-faultyStock-tab" data-toggle="pill" href="#custom-tabs-two-faultyStock" role="tab" aria-controls="custom-tabs-two-faultyStock" aria-selected="true">Faulty Spare Parts</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="custom-tabs-two-transferList-tab" data-toggle="pill" href="#custom-tabs-two-transferList" role="tab" aria-controls="custom-tabs-two-transferList" aria-selected="true">Transfer List</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="custom-tabs-two-stockTransfer-tab" data-toggle="pill" href="#custom-tabs-two-stockTransfer" role="tab" aria-controls="custom-tabs-two-stockTransfer" aria-selected="false">Stock Transfer</a>
                    </li>
                </ul>
            </div>
            <div class="card-body text-sm">
                <div class="tab-content" id="custom-tabs-two-tabContent">
                    <div class="tab-pane fade show active" id="custom-tabs-two-faultyStock" role="tabpanel" aria-labelledby="custom-tabs-two-faultyStock-tab">
                        <div class="row" style="margin-top:-15px">
                            <div class="col-md-12">
                                <div class="card card-gray-dark">
                                    <div class="card-header">
                                        <div class="row">
                                            <div class="col-md-3">
                                                @*<a href="#" class="float-left btn btn-sm btn-outline-primary" title="Details View">
                                                    <i class="fas fa-eye"></i> Go To Details View
                                                </a>*@
                                            </div>
                                            <div class="col-md-6">
                                                <h5 class="text-center text-bold">
                                                    Faulty Spare Parts Stock
                                                </h5>
                                            </div>
                                            <div class="col-md-3">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12" style="margin-top:-10px">
                                <div class="card card-navy">
                                    <div class="card-header">
                                        <h6 class="card-title">Search By</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row" style="margin-top:-15px">
                                            <div class="col-md-2">
                                                <label for="ddlLineNumber" class="control-label font-weight-bold">Floor</label>
                                                @Html.DropDownList("ddlLineNumber", (IEnumerable<SelectListItem>)ViewBag.ddlLineNumber, "--Select Floor--", new { @class = "form-control form-control-sm" })
                                            </div>
                                            <div class="col-md-2">
                                                <label for="ddlRepairLine" class="control-label font-weight-bold">Repair</label>
                                                <select id="ddlRepairLine" class="form-control form-control-sm">
                                                    <option value="0">--Select Repair--</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <label for="ddlModelName" class="control-label font-weight-bold">Model</label>
                                                @Html.DropDownList("ddlModelName", (IEnumerable<SelectListItem>)ViewBag.ddlModelName, "--Select Model--", new { @class = "form-control form-control-sm select2 select2-danger" })
                                            </div>
                                            <div class="col-md-4">
                                                <label for="ddlItems" class="control-label font-weight-bold">Items</label>
                                                @Html.DropDownList("ddlItems", (IEnumerable<SelectListItem>)ViewBag.ddlItems, "--Select Model--", new { @class = "form-control form-control-sm select2 select2-danger" })
                                            </div>
                                            <div class="col-md-2">
                                                <label class="control-label font-weight-bold">Qty(Less/Eq)</label>
                                                <input type="number" id="txtLessOrEq" class="form-control form-control-sm" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12" style="margin-top:-10px">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="col-md-12" id="dataContainer1">
                                            @{Html.RenderAction("GetFaultyItemStockInfo", new { @flag = "View" });}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade show" id="custom-tabs-two-transferList" role="tabpanel" aria-labelledby="custom-tabs-two-transferList-tab">
                        <div class="row" style="margin-top:-15px">
                            <div class="col-md-12">
                                <div class="card card-gray-dark">
                                    <div class="card-header">
                                        <div class="row">
                                            <div class="col-md-3">
                                                @*<a href="#" class="float-left btn btn-sm btn-outline-primary" title="Details View">
                                    <i class="fas fa-eye"></i> Go To Details View
                                </a>*@
                                            </div>
                                            <div class="col-md-6">
                                                <h5 class="text-center text-bold">
                                                    Faulty Transfer List
                                                </h5>
                                            </div>
                                            <div class="col-md-3">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12" style="margin-top:-10px">
                                <div class="card card-navy">
                                    <div class="card-header">
                                        <h6 class="card-title">Search By</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row" style="margin-top:-15px">
                                            <div class="col-md-2">
                                                <label for="txtTransferCode" class="control-label font-weight-bold">Transfer Code</label>
                                                <input type="text" name="search" id="txtTransferCode" class="form-control form-control-sm" placeholder="Search By Code" />
                                            </div>
                                            <div class="col-md-2">
                                                <label for="ddlFloorsTL" class="control-label font-weight-bold">Floor</label>
                                                @Html.DropDownList("ddlFloorsTL", (IEnumerable<SelectListItem>)ViewBag.ddlLineNumber, "--Select Floor--", new { @class = "form-control form-control-sm" })
                                            </div>
                                            <div class="col-md-2">
                                                <label for="ddlRepairLineTL" class="control-label font-weight-bold">Repair</label>
                                                <select id="ddlRepairLineTL" class="form-control form-control-sm">
                                                    <option value="0">--Select Repair--</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <label for="ddlStateStatusTL" class="control-label font-weight-bold">Status</label>
                                                @Html.DropDownList("ddlStateStatusTL", (IEnumerable<SelectListItem>)ViewBag.ddlStateStatus, "--Select Status--", new { @class = "form-control form-control-sm" })
                                            </div>
                                            <div class="col-md-2">
                                                <label class="control-label font-weight-bold">From Date</label>
                                                <div class="input-group input-group-sm ">
                                                    <input type="text" class="form-control form-control-sm date-datePicker ctrl-changed" id="dptFromDate" />
                                                    <div class="input-group-prepend cursor-pointer remove-date dptFromDate" style="cursor:pointer">
                                                        <span class="input-group-text">&#10008;</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="control-label font-weight-bold">To Date</label>
                                                <div class="input-group input-group-sm ">
                                                    <input type="text" class="form-control form-control-sm date-datePicker ctrl-changed" id="dptToDate" />
                                                    <div class="input-group-prepend remove-date dptToDate" style="cursor:pointer">
                                                        <span class="input-group-text">&#10008;</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12" style="margin-top:-10px">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="col-md-12" id="dataContainer2">
                                            @{Html.RenderAction("GetRepairSectionFaultyItemTransferList", new { @flag = "View" });}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade show " id="custom-tabs-two-stockTransfer" role="tabpanel" aria-labelledby="custom-tabs-two-stockTransfer-tab">
                        <div class="row" style="margin-top:-15px">
                            <div class="col-md-12">
                                <div class="card card-gray-dark">
                                    <div class="card-header">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <a href="/Production/GetRepairSectionFaultyItemTransferList" class="btn btn-sm btn-outline-primary" title="Back To List"><i class="fas fa-arrow-alt-circle-left"></i></a>
                                            </div>
                                            <div class="col-md-6">
                                                <h5 class="text-center text-bold">
                                                    Repair Section Faulty Item Transfer
                                                </h5>
                                            </div>
                                            <div class="col-md-3">
                                                <a href="#" class="btn btn-outline-danger btn-sm float-lg-right" id="btnReset" title="RESET UI"><i class="fas fa-sync-alt"></i></a>
                                            </div>
                                        </div>
                                    </div>
                                    <form id="frm">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" id="hdfWarehouseId" value="0" />
                                        <input type="hidden" id="hdfItemTypeId" value="0" />
                                        <input type="hidden" id="hdfItemId" value="0" />
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-2">
                                                    <label for="ddlProductionFloor" class="control-label font-weight-bold">Production Floor</label>
                                                    @Html.DropDownList("ddlProductionFloor", (IEnumerable<SelectListItem>)ViewBag.ddlLineNumber, "--Select Floor--", new { @class = "form-control form-control-sm" })
                                                    <span class="error hide req-floor font-weight-bold">Production Floor is required</span>
                                                </div>
                                                <div class="col-md-2">
                                                    <label for="ddlRepairLineST" class="control-label font-weight-bold">Repair Line</label>
                                                    <select id="ddlRepairLineST" class="form-control form-control-sm">
                                                        <option value="0">--Select Repair--</option>
                                                    </select>
                                                    <span class="error hide req-repair">Repair line is required</span>
                                                </div>
                                                <div class="col-md-2">
                                                    <label for="ddlModelNameST" class="control-label font-weight-bold">Model</label>
                                                    @Html.DropDownList("ddlModelNameST", (IEnumerable<SelectListItem>)ViewBag.ddlModelName, "--Select Model--", new { @class = "form-control form-control-sm select2 select2-danger" })
                                                    <span class="error hide req-model">Model is required</span>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="ddlItemsST" class="control-label font-weight-bold">Item</label>
                                                    <select id="ddlItemsST" class="form-control form-control-sm select2 select2-danger">
                                                        <option value="">--Select Items--</option>
                                                    </select>
                                                    <span class="error hide req-item">Item is required</span>
                                                    <span class="error hide duplicate-itemName">The Item is already added into the list!</span>
                                                </div>
                                                <div class="col-md-2">
                                                    <label for="txtQuantity" class="control-label font-weight-bold">
                                                        Quantity
                                                        <span id="stockQty"></span>
                                                    </label>
                                                    <div class="row">
                                                        <div class="col-md-9">
                                                            <input type="number" id="txtQuantity" class="form-control form-control-sm" />
                                                        </div>
                                                        <div class="col-md-3">
                                                            <span id="unitName" class="float-left font-weight-bold mt-2" style="color:darkblue"></span>
                                                        </div>
                                                    </div>
                                                    <span class="error hide require-quantity">Quantity is required</span>
                                                    <span class="error hide req-stockOver">Stock is not available</span>
                                                </div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-md-4">
                                                    <label for="txtRemarks" class="control-label font-weight-bold">Item Remarks</label>
                                                    <div class="row">
                                                        <div class="col-md-10">
                                                            <textarea type="text" name="remarks" cols="5" rows="1" value="" id="txtTransferRemarks" class="form-control form-control-sm"></textarea>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <button type="button" class="btn btn-sm btn-warning float-right" id="btnAddToList" title="Add To List"><i class="fas fa-plus"></i></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <table class="table table-bordered table-sm table-striped table-responsive-lg text-sm" id="tblItems">
                                                        <thead class="text-center">
                                                            <tr class="badge-light">
                                                                <th colspan="9">
                                                                    <button type="submit" id="btnSubmit" class="btn btn-sm btn-success float-left">
                                                                        Save
                                                                        <i class="fas fa-paper-plane">
                                                                        </i>
                                                                    </button>
                                                                </th>
                                                            </tr>
                                                            <tr class="btn-dark">
                                                                <th style="width:10%">#SL</th>
                                                                <th style="width:10%">Model Name</th>
                                                                <th style="width:50%">Item Name</th>
                                                                <th style="width:10%">Qunatity</th>
                                                                <th style="width:10%">Type Of Unit</th>
                                                                <th style="width:10%">Action</th>
                                                                <th class="hide model"></th>
                                                                <th class="hide warehouse"></th>
                                                                <th class="hide itemtype"></th>
                                                                <th class="hide item"></th>
                                                                <th class="hide unit"></th>
                                                                <th class="hide unitName"></th>
                                                            </tr>
                                                        </thead>
                                                        <tbody></tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script type="text/javascript">

        // Stock List
        var ddlLineNumber = $("#ddlLineNumber");
        var ddlRepairLine = $("#ddlRepairLine");
        var ddlModelName = $("#ddlModelName");
        var ddlItems = $("#ddlItems");
        var txtLessOrEq = $("#txtLessOrEq");
        var pageNo = 1;
        var warehouseStock = '';
        var itemTypeStock = '';
        var itemStock = '';

        // Transfer List //

        var txtTransferCode = $("#txtTransferCode");
        var ddlFloorsTL = $("#ddlFloorsTL");
        var ddlRepairLineTL = $("#ddlRepairLineTL");
        var ddlStateStatusTL = $('#ddlStateStatusTL');
        var dptFromDate = $("#dptFromDate");
        var dptToDate = $("#dptToDate");

        // Stock Transfer
        var ddlProductionFloor = $("#ddlProductionFloor");
        var ddlRepairLineST = $("#ddlRepairLineST");
        var ddlModelNameST = $("#ddlModelNameST");
        var ddlItemsST = $("#ddlItemsST");
        var txtQuantity = $("#txtQuantity");
        var hdfItemId = $("#hdfItemId");
        var hdfItemTypeId = $("#hdfItemTypeId");
        var hdfWarehouseId = $("#hdfWarehouseId");
        var txtTransferRemarks = $("#txtTransferRemarks");
        var tblItems = $("#tblItems");
        var uId = "";
        var uName = "";

        $(document).ready(function () {
            //Initialize Select2 Elements
            $('.select2').select2();

            //Initialize Select2 Elements
            $('.select2bs4').select2({
                theme: 'bootstrap4'
            });

            dptFromDate.prop('readonly', true);
            dptToDate.prop('readonly', true);
            dptFromDate.css("background-color", "#fff");
            dptToDate.css("background-color", "#fff");

            $('#dptFromDate').datepicker({
                format: "dd MM yyyy",
                orientation: "bottom auto",
                todayHighlight: true
            });
            $('#dptToDate').datepicker({
                format: "dd MM yyyy",
                orientation: "bottom auto",
                todayHighlight: true
            });
        })

        function getItemDetailsByStock() {
            warehouseStock = '';
            itemTypeStock = '';
            itemStock = '';
            if (ddlItems.val() != '') {
                itemStock = ddlItems.val().substring(0, ddlItems.val().indexOf("#"));
                itemTypeStock = ddlItems.val().substring(ddlItems.val().indexOf("#") + 1, ddlItems.val().lastIndexOf("#"));
                warehouseStock = ddlItems.val().substring(ddlItems.val().lastIndexOf("#") + 1);
            }
        }

        ddlLineNumber.change(function () {
            clearDropdown("ddlQCLine");
            if (ddlLineNumber.val() != "") {
                LoadDropDown('/Common/GetRepairLineByLine', 'POST', ddlRepairLine, JSON.stringify({ lineId: ddlLineNumber.val() }));
            }
            LoadDataTable();
        })

        ddlRepairLine.change(function () {
            LoadDataTable();
        })

        ddlModelName.change(function () {
            LoadDataTable();
        })

        ddlItems.change(function () {
            LoadDataTable();
        })

        txtLessOrEq.keyup(function () {
            LoadDataTable();
        })

        function LoadDataTable() {
            getItemDetailsByStock();
            var data = { flag: "search", lineId: ddlLineNumber.val(), repairId: TryParseInt(ddlRepairLine.val(), 0), modelId: TryParseInt(ddlModelName.val(), 0), qcId: 0, warehouseId: TryParseInt(warehouseStock, 0), itemTypeId: TryParseInt(itemTypeStock, 0), itemId: TryParseInt(itemStock, 0), lessOrEq: txtLessOrEq.val(), page: pageNo };

            $.when(getReqWithData('html', 'GET', '/Production/GetFaultyItemStockInfo', data)).then(function (res, status) {
                console.log(status);
                if (status === "success") {
                    $("#dataContainer1").fadeOut('500', function () {
                        $("#dataContainer1").empty();
                        $("#dataContainer1").append(res).fadeIn('500');
                    });
                }
            }).fail(function (error) {
                console.log(error);
            });
            pageNo = 1;
        }
        // Pagination
        $(document).on('click', 'a.page-link', function (e) {
            e.preventDefault();
            if (!$(this).hasClass('current-page')) {
                pageNo = $(this).attr('data-page-no');
                LoadDataTable();
            }
        })


        // Transfer List
        $(document).on('click', 'div.remove-date', function () {
            if ($(this).hasClass("dptToDate")) {
                if (dptToDate.val() !== '') {
                    dptToDate.val('');
                    LoadDataTableTransferList();
                }
            }
            if ($(this).hasClass("dptFromDate")) {
                if (dptFromDate.val() !== '') {
                    dptFromDate.val('');
                    LoadDataTableTransferList();
                }
            }
        })

        ddlFloorsTL.change(function () {
            clearDropdown("ddlRepairLineTL");
            if (ddlFloorsTL.val() != "") {
                LoadDropDown('/Common/GetRepairLineByLine', 'POST', ddlRepairLineTL, JSON.stringify({ lineId: ddlFloorsTL.val() }));
            }
            LoadDataTableTransferList();
        })

        ddlRepairLineTL.change(function () {
            LoadDataTableTransferList();
        })
       
        txtTransferCode.keyup(function () {
            LoadDataTableTransferList();
        })

        dptFromDate.change(function () {
            LoadDataTableTransferList();
        })

        dptToDate.change(function () {
            LoadDataTableTransferList();
        })

        ddlStateStatusTL.change(function () {
            LoadDataTableTransferList();
        })

        // Pagination
        $(document).on('click', 'a.page-link', function (e) {
            e.preventDefault();
            if (!$(this).hasClass('current-page')) {
                pageNo = $(this).attr('data-page-no');
            }
        })

        function LoadDataTableTransferList() {
            var data = { flag: "view", floorId: TryParseInt(ddlFloorsTL.val(), 0), repairLineId: TryParseInt(ddlRepairLineTL.val(), 0), transferCode: $.trim(txtTransferCode.val()), status: ddlStateStatusTL.val(), fromDate: dptFromDate.val(), toDate: dptToDate.val(), page: pageNo };

            $.when(getReqWithData('html', 'GET', '/Production/GetRepairSectionFaultyItemTransferList', data)).then(function (res, status) {
                if (status === "success") {
                    $("#dataContainer2").fadeOut('500', function () {
                        $("#dataContainer2").empty();
                        $("#dataContainer2").append(res).fadeIn('500');
                    });
                }
            }).fail(function (error) {
                console.log(error);
            });
            pageNo = 1;
        }

        // Stock Transfer //

        ddlProductionFloor.change(function () {
            clearDropdown("ddlRepairLineST");
            if (ddlProductionFloor.val() != "") {
                LoadDropDown('/Common/GetRepairLineByLine', 'POST', ddlRepairLineST, JSON.stringify({ lineId: ddlProductionFloor.val() }));
            }
            LoadItems();
        })

        ddlRepairLineST.change(function () {
            LoadItems();
        })

        ddlModelNameST.change(function () {
            LoadItems();
        })

        $("#btnReset").click(function (e) {
            e.preventDefault();
            clearAll();
        })

        function LoadItems() {
            $("#unitName").text('');
            $("#stockQty").text('(0)');
            clearDropdown("ddlItemsST");
            if (ddlProductionFloor.val() != "" && ddlRepairLineST.val() != "" && ddlModelNameST.val() != "") {
                LoadDropDown('/Common/GetItemDetailByRepairFaultySection', 'POST', ddlItemsST, JSON.stringify({ floorId: ddlProductionFloor.val(), repairLineId: ddlRepairLineST.val(), modelId: ddlModelNameST.val() }));
            }
        }

        ddlItemsST.change(function () {
            LoadItemStock();
        });

        function gethdfValues() {
            hdfItemId.val('0');
            hdfItemTypeId.val('0');
            hdfWarehouseId.val('0');
            var itemVal = ddlItemsST.val();
            var val1 = itemVal.substring(0, itemVal.indexOf("#"));
            hdfItemId.val(val1);
            var val2 = itemVal.substring(itemVal.indexOf("#") + 1, itemVal.lastIndexOf("#"));
            hdfItemTypeId.val(val2);
            var val3 = itemVal.substring(itemVal.lastIndexOf("#") + 1, itemVal.length);
            hdfWarehouseId.val(val3);
        }

        function LoadItemStock() {
            gethdfValues();
            uId = "0";
            uName = "";
            $("#unitName").text('');
            $("#stockQty").text('(0)');
            txtQuantity.val('0');
            if (hdfItemId.val() != "" && TryParseInt(hdfItemId.val(), 0) > 0 && ddlRepairLineST.val() != "" && TryParseInt(ddlRepairLineST.val(), 0) > 0 && TryParseInt(ddlModelNameST.val(), 0) > 0) {

                $.when(postReqWithToken(dataType.applicationJson, dataType.json, 'POST', '/Common/GetFaultyItemStockInfoByRepairAndModelAndItem', JSON.stringify({ itemId: hdfItemId.val(), repairId: ddlRepairLineST.val(), modelId: TryParseInt(ddlModelNameST.val(), 0) }), getToken())).then(function (res, status) {
                    console.log(res);
                    console.log(status);
                    if (status == "success") {
                        $("#unitName").html('<b> (' + res.unitSymbol + ') </b>');
                        $("#stockQty").text('(' + res.stockQty + ')');
                        uName = res.unitSymbol;
                        uId = res.unitid;
                    }
                }).fail(function (error) {
                    consoleLog(error);
                })
            }
        }

        function clearCtrl() {
            ddlItemsST.val('');
            ddlItemsST.trigger('change');
            txtTransferRemarks.val('');
        }

        function validateInput() {
            var isValid = true;
            $(".error").addClass('hide');
            if (ddlProductionFloor.val() == "") {
                $(".req-floor").removeClass('hide');
                isValid = false;
            }
            if (ddlRepairLineST.val() == "") {
                isValid = false;
                $(".req-repair").removeClass("hide");
            }
            if (ddlModelNameST.val() == "") {
                isValid = false;
                $(".req-model").removeClass("hide");
            }
            if (ddlItemsST.val() == "") {
                isValid = false;
                $(".req-item").removeClass("hide");
            }
            if (TryParseInt(txtQuantity.val(), 0) <= 0) {
                isValid = false;
                $(".req-quantity").removeClass("hide");
            }
            else {
                var sq = $("#stockQty").text().trim();
                sq = sq.substring(1, sq.length - 1);
                //console.log("Stock Qty");
                //console.log(sq);
                if (TryParseInt(txtQuantity.val(), 0) > TryParseInt(sq, 0)) {
                    isValid = false;
                    $('.req-stockOver').removeClass('hide');
                }
                else {
                    // Check Stock In Db
                }
            }

            var count = $("#tblItems tbody tr").length;
            if (count > 0) {
                $.each($("#tblItems tbody tr"), function (index, item) {
                    var tds = $(this).children('td');
                    var itemId = tds.eq(9).html();
                    var itemVal = ddlItemsST.val();
                    var val1 = itemVal.substring(0, itemVal.indexOf("#"));
                    if (itemId == val1) {
                        isValid = false;
                        $(".duplicate-itemName").removeClass('hide');
                    }
                })
            }
            return isValid;
        }

        function validateSubmit() {
            var isVaild = true;
            if (ddlProductionFloor.val() == "") {
                $(".req-floor").removeClass('hide');
                isValid = false;
            }
            if (ddlRepairLineST.val() == "") {
                isValid = false;
                $(".req-repair").removeClass("hide");
            }
            if ($("#tblItems tbody tr").length == 0) {
                alert("Please add data into the table");
                isValid = false;
            }
            else {
                // Item Stock checking in Db
            }
            return isVaild;
        }

        function clearAll() {
            ddlProductionFloor.val('');
            ddlProductionFloor.trigger('change');
            ddlModelNameST.val('');
            ddlModelNameST.trigger('change');
            $("#tblItems tbody").empty();

        }

        $("#btnAddToList").click(function (e) {
            e.preventDefault();

            if (validateInput()) {
                disable("ddlProductionFloor");
                disable("ddlRepairLineST");
                gethdfValues();
                var td1 = "<td class='text-center text-bold'>" + ($("#tblItems tbody tr").length + 1) + "</td>";
                var td2 = "<td class='text-center'>" + $("#ddlModelNameST option:selected").text() + "</td>";
                var td3 = "<td>" + $("#ddlItemsST option:selected").text() + "</td>";
                var td4 = "<td class='text-center'>" + txtQuantity.val() + "</td>";
                var td5 = "<td class='text-center'>" + $("#unitName").text() + "</td>";
                var td6 = "<td class='text-center'><a href='#' class='btn btn-sm btn-danger data-onfly-del'><i class='far fa-trash-alt'></i></a></td>";
                var td7 = "<td class='hide'>" + ddlModelNameST.val() + "</td>";
                var td8 = "<td class='hide'>" + hdfWarehouseId.val() + "</td>";
                var td9 = "<td class='hide'>" + hdfItemTypeId.val() + "</td>";
                var td10 = "<td class='hide'>" + hdfItemId.val() + "</td>";
                var td11 = "<td class='hide'>" + uId + "</td>";
                var td12 = "<td class='hide'>" + uName + "</td>";

                var tr = "<tr>" + td1 + td2 + td3 + td4 + td5 + td6 + td7 + td8 + td9 + td10 + td11 + td12 + "</tr>";

                if ($("#tblItems tbody tr").length == 0) {
                    $("#tblItems tbody").append(tr);
                }
                else {
                    $("#tblItems tbody tr").eq(0).before(tr);
                }

                if ($("#tblItems tbody tr").length > 1) {
                    //MargeSecondCell();
                }
                //fixit(tblItems);
                clearCtrl();
            }
        })

        $("#btnSubmit").click(function (e) {
            e.preventDefault();
            if (validateSubmit()) {
                bootbox.confirm("Are you sure you want to save data", function (result) {
                    if (result) {
                        disable("#btnSubmit");
                        // data....
                        var info = {
                            ProductionFloorId: TryParseInt(ddlProductionFloor.val(), 0),
                            ProductionFloorName: $("#ddlProductionFloor option:selected").text(),
                            RepairLineId: TryParseInt(ddlRepairLineST.val(), 0),
                            RepairLineName: $("#ddlRepairLineST option:selected").text(),
                        };
                        var detail = []; detail.length = 0;

                        $.each($("#tblItems tbody tr"), function (index, item) {
                            var tds = $(this).children('td');
                            var modelName = tds.eq(1).html();
                            var item = tds.eq(2).html();
                            var itemName = item.substring(0, item.lastIndexOf("[") - 1);
                            var itemTypeName = item.substring(item.lastIndexOf("[") + 1, item.lastIndexOf("-"));
                            var warehouseName = item.substring(item.lastIndexOf("-") + 1, item.lastIndexOf("]"));
                            var qty = tds.eq(3).html();

                            var modelId = tds.eq(6).html();
                            var warehouseId = tds.eq(7).html();
                            var itemTypeId = tds.eq(8).html();
                            var itemId = tds.eq(9).html();
                            var unit = tds.eq(10).html();
                            var unitName = tds.eq(11).html();
                            detail.push({
                                ProductionFloorId: TryParseInt(ddlProductionFloor.val(), 0),
                                ProductionFloorName: $("#ddlProductionFloor option:selected").text(),
                                RepairLineId: TryParseInt(ddlRepairLineST.val(), 0),
                                RepairLineName: $("#ddlRepairLineST option:selected").text(),
                                QCLineId: 0,
                                QCLineName: "",
                                DescriptionId: TryParseInt(modelId, 0),
                                ModelName: modelName,
                                WarehouseId: TryParseInt(warehouseId, 0),
                                WarehouseName: warehouseName,
                                ItemTypeId: TryParseInt(itemTypeId, 0),
                                ItemTypeName: itemTypeName,
                                ItemId: TryParseInt(itemId, 0),
                                ItemName: itemName,
                                FaultyQty: qty,
                                UnitId: TryParseInt(unit, 0),
                                UnitName: unitName
                            });
                        })
                        console.log("Detail");
                        console.log(detail);

                        info.RepairSectionFaultyItemRequisitionDetails = detail;
                        var data = JSON.stringify({ info: info })

                        console.log('data');
                        console.log(data);

                        $.when(postReqWithToken(dataType.applicationJson, dataType.json, type.post, '/Production/SaveRepairSectionFaultyItemTransfer', data, getToken())).then(function (res, status) {
                            if (res === true && status === "success") {
                                $('.toastrDefaultSuccess').trigger('click'); clearAll();

                            }
                            else {
                                $('.toastrDefaultError').trigger('click');
                            }
                            enable("#btnSubmit");
                        }).fail(function (error) {
                            console.log(error);
                            enable("#btnSubmit");
                        })
                    }
                })
            }
        })

        //function MargeSecondCell() {
        //    $("#tblItems tbody").each(function () {
        //        var row = $(this).children('td').eq(1);
        //        var values = $(this).find("tr>td:nth-child(2)")
        //        console.log("values");
        //        console.log(values);
        //        console.log('Values Lenght');
        //        console.log(values.length);
        //        var run = 1

        //        for (var i = values.length - 1; i > -1; i--) {
        //            console.log("values.eq(i)");
        //            console.log(values.eq(i));
        //            console.log("values.eq(i).text()");
        //            console.log(values.eq(i).text());
        //            console.log("values.eq(i - 1).text()");
        //            console.log(values.eq(i - 1).text());
        //            if (values.eq(i).text() === values.eq(i - 1).text()) {
        //                //values.eq(i).remove()
        //                run++
        //            } else {
        //                values.eq(i).attr("rowspan", run)
        //                run = 1
        //            }
        //        }
        //    })
        //}

        $(document).on("click", "a.data-onfly-del", function (e) {
            e.preventDefault();
            var index = $(this).parent().parents('tbody tr').index();
            if (bootbox.confirm("Are you sure you want to delete?", function (result) {
                if (result === true) {
                    removeTableRow("#tblItems tbody", index);
                    fnFixTheTbodyRowSerialInDecsOrder("#tblItems", index);
                    $("#tblItems tbody tr").removeClass("btn-success");
                };
            }));
        })
       
    </script>
}