
@{
    ViewBag.Title = "Packaging Finish Goods Process";
}

<div class="row text-sm">
    <div class="col-md-12">
        <div class="card card-primary card-outline card-tabs">
            <div class="card-header p-0 pt-1 border-bottom-0">
                <ul class="nav nav-tabs" id="custom-tabs-two-tab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="custom-tabs-two-finishStock-tab" data-toggle="pill" href="#custom-tabs-two-finishStock" role="tab" aria-controls="custom-tabs-two-finishStock" aria-selected="true">Finish Goods Stock</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="custom-tabs-two-transferList-tab" data-toggle="pill" href="#custom-tabs-two-transferList" role="tab" aria-controls="custom-tabs-two-transferList" aria-selected="true">Finish Goods Transfer List</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="custom-tabs-two-cartoon-tab" data-toggle="pill" href="#custom-tabs-two-cartoon" role="tab" aria-controls="custom-tabs-two-cartoon" aria-selected="true"> Finish Goods Packaging</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                @Html.AntiForgeryToken()
                <div class="tab-content" id="custom-tabs-two-tabContent">
                    <div class="tab-pane fade show active" id="custom-tabs-two-finishStock" role="tabpanel" aria-labelledby="custom-tabs-two-finishStock-tab">
                        <div class="row" style="margin-top:-15px">
                            <div class="col-md-12">
                                <div class="card card-gray-dark">
                                    <div class="card-header">
                                        <div class="row">
                                            <div class="col-md-3">
                                                @*<a href="#" class="float-left btn btn-sm btn-outline-primary" title="Details View">
                                        <i class="fas fa-eye"></i> Go To Details View
                                    </a>*@
                                            </div>
                                            <div class="col-md-6">
                                                <h5 class="text-center text-bold">
                                                    Finish Goods Stock
                                                </h5>
                                            </div>
                                            <div class="col-md-3">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12" style="margin-top:-10px">
                                <div class="card card-navy">
                                    <div class="card-header">
                                        <h6 class="card-title">Search By</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row" style="margin-top:-15px">
                                            <div class="col-md-3">
                                                <label for="ddlPackagingLineStock" class="control-label font-weight-bold">Packaging Line</label>
                                                @Html.DropDownList("ddlPackagingLineStock", (IEnumerable<SelectListItem>)ViewBag.ddlPackagingLine, "--Select Packaging Line--", new { @class = "form-control form-control-sm" })
                                            </div>
                                            <div class="col-md-2">
                                                <label for="ddlModelNameStock" class="control-label font-weight-bold">Model</label>
                                                @Html.DropDownList("ddlModelNameStock", (IEnumerable<SelectListItem>)ViewBag.ddlModelName, "--Select Model--", new { @class = "form-control form-control-sm ctrl-change select2 select2-danger" })
                                            </div>
                                            <div class="col-md-3">
                                                <label for="ddlItemsStock" class="control-label font-weight-bold">Item</label>
                                                @Html.DropDownList("ddlItemsStock", (IEnumerable<SelectListItem>)ViewBag.ddlItems, "--Select Item--", new { @class = "form-control form-control-sm ctrl-change select2 select2-danger" })
                                            </div>
                                            <div class="col-md-2">
                                                <label class="control-label font-weight-bold" for="txtLessOrEqStock">Qty(Le/Eq)</label>
                                                <input type="number" id="txtLessOrEqStock" class="form-control form-control-sm" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12" style="margin-top:-10px">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="col-md-12" id="dataContainer1">
                                            @{Html.RenderAction("GetPackagingFinishGoodsProcess", new { @flag = "stockinfo" });}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade show" id="custom-tabs-two-transferList" role="tabpanel" aria-labelledby="custom-tabs-two-transferList-tab">
                        <div class="row" style="margin-top:-15px">
                            <div class="col-md-12">
                                <div class="card card-gray-dark">
                                    <div class="card-header">
                                        <div class="row">
                                            <div class="col-md-3">
                                               
                                            </div>
                                            <div class="col-md-6">
                                                <h5 class="text-center text-bold">
                                                    Finish Goods Tranfer List
                                                </h5>
                                            </div>
                                            <div class="col-md-3">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12" style="margin-top:-10px">
                                <div class="card card-navy">
                                    <div class="card-header">
                                        <h6 class="card-title">Search By</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row" style="margin-top:-15px">
                                            <div class="col-md-3">
                                                <label for="ddlPackagingLineTL" class="control-label font-weight-bold">Packaging Line</label>
                                                @Html.DropDownList("ddlPackagingLineTL", (IEnumerable<SelectListItem>)ViewBag.ddlPackagingLine, "--Select Packaging Line--", new { @class = "form-control form-control-sm" })
                                            </div>
                                            <div class="col-md-2">
                                                <label for="ddlModelNameTL" class="control-label font-weight-bold">Model</label>
                                                @Html.DropDownList("ddlModelNameTL", (IEnumerable<SelectListItem>)ViewBag.ddlModelName, "--Select Model--", new { @class = "form-control form-control-sm ctrl-change select2 select2-danger" })
                                            </div>
                                            <div class="col-md-3">
                                             
                                            </div>
                                            <div class="col-md-2">
                                              
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12" style="margin-top:-10px">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="col-md-12" id="dataContainer2">
                                            @{Html.RenderAction("GetPackagingFinishGoodsProcess", new { @flag = "transferinfo" });}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade show" id="custom-tabs-two-cartoon" role="tabpanel" aria-labelledby="custom-tabs-two-cartoon-tab">
                        <div class="row" style="margin-top:-15px">
                            <div class="col-md-12">
                                <div class="card card-gray-dark">
                                    <div class="card-header">
                                        <div class="row">
                                            <div class="col-md-3">
                                            </div>
                                            <div class="col-md-6">
                                                <h5 class="text-center text-bold">
                                                    Finish Goods Packaging
                                                </h5>
                                            </div>
                                            <div class="col-md-3">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12" style="margin-top:-10px">
                                <div class="card card-navy">
                                    <div class="card-body">
                                        <div class="row" style="margin-top:-15px">
                                            <div class="col-md-5">
                                                <div class="row">
                                                    <div class="col-md-7">
                                                        <label for="ddlPackagingLinePacking" class="control-label font-weight-bold">Packaging Line</label>
                                                        @Html.DropDownList("ddlPackagingLinePacking", (IEnumerable<SelectListItem>)ViewBag.ddlPackagingLine, "--Select Packaging Line--", new { @class = "form-control form-control-sm" })
                                                        <span class="error hide req-pack">Packaging line is required</span>
                                                    </div>
                                                    <div class="col-md-5">
                                                        <label for="ddlModelPackaging" class="control-label font-weight-bold">Model</label>
                                                        @Html.DropDownList("ddlModelPackaging", (IEnumerable<SelectListItem>)ViewBag.ddlModelName, "--Select Model--", new { @class = "form-control form-control-sm select2 select2-danger" })
                                                        <span class="error hide req-model">Model is required</span>
                                                    </div>
                                                    <div class="col-md-3 hide">
                                                        <label for="ddlWarehousePackaging" class="control-label font-weight-bold">Warehouse</label>
                                                        @Html.DropDownList("ddlWarehousePackaging", (IEnumerable<SelectListItem>)ViewBag.ddlWarehouse3, new { @class = "form-control form-control-sm select2 select2-danger" })
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <label class="control-label font-weight-bold" for="txtIMEIScaning">IMEI</label>
                                                        <input type="text" id="txtIMEIScaning" class="form-control form-control-sm" placeholder="Scan IMEI Here" />
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <label class="control-label font-weight-bold" for="txtCarton">Carton No</label>
                                                        <input type="text" id="txtCarton" class="form-control form-control-sm" />
                                                        <span class="error hide req-carton">Input Carton</span>
                                                    </div>
                                                    <div class="col-md-4 hide">
                                                        <label class="control-label font-weight-bold" for="txtQuantity">Qty</label>
                                                        <input type="number" id="txtQuantity" class="form-control form-control-sm" />
                                                        <span class="error hide req-qty">Input Qty</span>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="control-label font-weight-bold" for="txtNetWeight">Net Weight</label>
                                                        <input type="number" id="txtNetWeight" class="form-control form-control-sm" />
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-7">
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <table class="table table-sm table-bordered table-responsive-lg table-striped text-sm" id="tblIMEIItem">
                                                            <thead class="">
                                                                <tr>
                                                                    <th class="text-center" colspan="6">
                                                                        <span class="error hide empty-data">Please add IMEI</span>
                                                                        <button type="button" class="btn float-right btn-sm btn-success btn-flat" id="btnSaveCarton">
                                                                            <i class="fas fa-paper-plane"> Save</i>
                                                                        </button>
                                                                    </th>
                                                                </tr>
                                                                <tr class="btn-dark text-center">
                                                                    <th style="width:10%">#SL</th>
                                                                    <th style="width:40%">IMEI</th>
                                                                    <th style="width:40%">Item-Color</th>
                                                                    <th style="width:10%">Action</th>
                                                                    <th class="hide allIMEI"></th>
                                                                    <th class="hide QRCode"></th>
                                                                </tr>
                                                            </thead>
                                                            <tbody></tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            @*<div class="col-md-2">
                                    <label class="control-label font-weight-bold" for="dptFromDateTI">From Date</label>
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control form-control-sm date-datePicker ctrl-changed-2" id="dptFromDateTI" />
                                        <div class="input-group-prepend cursor-pointer remove-dateTI dptFromDate" style="cursor:pointer">
                                            <span class="input-group-text">&#10008;</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label class="control-label font-weight-bold" for="dptToDateTI">To Date</label>
                                    <div class="input-group input-group-sm ">
                                        <input type="text" class="form-control form-control-sm date-datePicker ctrl-changed-2" id="dptToDateTI" />
                                        <div class="input-group-prepend remove-dateTI dptToDate" style="cursor:pointer">
                                            <span class="input-group-text">&#10008;</span>
                                        </div>
                                    </div>
                                </div>*@
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modalDetails" role="dialog" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header alert-secondary">
                <input type="hidden" id="hdfInfoId" />
                <input type="hidden" id="hdfRowIndex" />
                <h4 id="modalHeading" class="modal-title">Finish Goods Transfer Details</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body" id="modalDataContainer1">

            </div>
        </div>
    </div>
</div>

@section scripts{
    <script type="text/javascript">
        var hdfInfoId = $("#hdfInfoId");
        var hdfRowIndex = $("#hdfRowIndex");
        // Stock //
        var ddlPackagingLineStock = $("#ddlPackagingLineStock");
        var ddlModelNameStock = $("#ddlModelNameStock");
        var ddlItemsStock = $("#ddlItemsStock");
        var txtLessOrEqStock = $("#txtLessOrEqStock");
        var pageNo = 1;

        // Goods Packaging //
        var txtIMEIScaning = $("#txtIMEIScaning");
        var ddlPackagingLinePacking = $("#ddlPackagingLinePacking");
        var ddlModelPackaging = $("#ddlModelPackaging");
        var ddlWarehousePackaging = $("#ddlWarehousePackaging");
        var txtCarton = $("#txtCarton");
        var txtQuantity = $("#txtCarton");
        var txtNetWeight = $("#txtNetWeight");

        // Transfer List //
        var ddlPackagingLineTL = $("#ddlPackagingLineTL");
        var ddlModelNameTL = $("#ddlModelNameTL");

        $(document).ready(function () {
            //Initialize Select2 Elements
            $('.select2').select2();

            //Initialize Select2 Elements
            $('.select2bs4').select2({
                theme: 'bootstrap4'
            });
        })

        //================== Finish Stock Info =================//

        ddlPackagingLineStock.change(function () {
            LoadDataTableStockInfo();
        })

        ddlItemsStock.change(function () {
            LoadDataTableStockInfo();
        })

        $(document).on('change', '.ctrl-change', function () {
            LoadDataTableStockInfo();
        })

        txtLessOrEqStock.keyup(function () {
            LoadDataTableStockInfo();
        })

        function LoadDataTableStockInfo() {
            var packagingLine = ddlPackagingLineStock.val() != "" ? ddlPackagingLineStock.val().split("#") : ["0", "0"];
            var itemId = ddlItemsStock.val() != "" ? ddlItemsStock.val().split("#") : ["0", "0", "0"];
            var data = { flag: "stockinfo", floorId: packagingLine[1], packagingLineId: packagingLine[0], modelId: TryParseInt(ddlModelNameStock.val(), 0), qcId: 0, warehouseId: TryParseInt(itemId[2], 0), itemTypeId: TryParseInt(itemId[1], 0), itemId: TryParseInt(itemId[0], 0), lessOrEq: txtLessOrEqStock.val(), page: pageNo };

            $.when(getReqWithData('html', 'GET', '/Production/GetPackagingFinishGoodsProcess', data)).then(function (res, status) {
                console.log(status);
                if (status === "success") {
                    $("#dataContainer1").fadeOut('500', function () {
                        $("#dataContainer1").empty();
                        $("#dataContainer1").append(res).fadeIn('500');
                    });
                }
            }).fail(function (error) {
                console.log(error);
            });
            //pageNo = 1;
        }

        //================== End of Finish Stock Info =================//

        //================== Transfer List  ==================//

        ddlPackagingLineTL.change(function () {
            LoadFinishGoodsTransferList();
        })

        ddlModelNameTL.change(function () {
            LoadFinishGoodsTransferList();
        })

        function LoadFinishGoodsTransferList() {
            var packaging = ddlPackagingLineTL.val() !="" ? ddlPackagingLineTL.val().split("#"): ["0","0","0"];
            var data = { flag:"transferinfo", floorId: packaging[1], packagingLineId: packaging[0], modelId: TryParseInt(ddlModelNameTL.val(), 0) };
            $.when(getReqWithData(dataType.html, type.post, '/Production/GetPackagingFinishGoodsProcess', data)).then(function (res,status) {
                console.log(res);
                if (status === "success") {
                    $("#dataContainer2").fadeOut('500', function () {
                        $("#dataContainer2").empty();
                        $("#dataContainer2").append(res).fadeIn('500');
                    });
                }
            }).fail(function (error) {
                console.log(error);
            })
        }

        $(document).on('click', '.data-item-finishGoods', function (e) {
            e.preventDefault();
            var id = TryParseInt($(this).attr("data-item-val"),0);
            var idx = $(this).parent().parents('tr').index();
            if (id > 0) {
                hdfInfoId.val(id);
                hdfRowIndex.val(idx);
                LoadTransferDetail(id);
            }
        })

        function LoadTransferDetail(id) {
            var data = { flag:"transferdetail", transferId: id };
            $.when(getReqWithData(dataType.html, type.get, '/Production/GetPackagingFinishGoodsProcess', data)).then(function (res, status) {
                if (status === "success") {
                    hdfInfoId.val(id);
                    $("#modalDetails").modal("show");
                    $("#modalDataContainer1").empty();
                    $("#modalDataContainer1").append(res);
                }
            }).fail(function (error) {
                console.log(error);
            })
        }

        //================== End of Transfer List  ==================//

        //================== Finish Goods Packaging =================//
        txtIMEIScaning.change(function () {
            if ($.trim(txtIMEIScaning.val()) !== "") {
                getIMEIInfo($.trim(txtIMEIScaning.val()));
            }
        })

        function validateIMEI() {
            var isValid = true;
            if (ddlPackagingLinePacking.val() == "") {
                isValid = false;
                toastrErrorAlert('Please Select Packaging line');
            }
            if (ddlModelPackaging.val() == "") {
                isValid = false;
                toastrErrorAlert('Please Select Model');
            }
            return isValid;
        }

        function getIMEIInfo(imei) {
            //IMEIinFinishGoods
            //string imei,long floorId, long packagingId
            if (validateIMEI()) {
                var packagingLine = ddlPackagingLinePacking.val() != "" ? ddlPackagingLinePacking.val().split("#") : ["0","0","0"]
                var data = JSON.stringify({ imei: $.trim(imei), floorId: packagingLine[1], packagingId: packagingLine[0] });
                $.when(postReqWithData(dataType.applicationJson, dataType.json, type.post, '/Common/IMEIinFinishGoods', data))
                    .then(function (res, status)
                    {
                        if (status === "success") {
                            if (res != null) {
                                console.log("...........IMEI Carton...........");
                                console.log(res);
                                if (res.StateStatus === "Finish") {
                                    if (findDuplication(res.CodeNo)) {
                                        bindIMEIData(res);
                                    }
                                    else {
                                        toastrErrorAlert("This IMEI has been already added");
                                    }
                                }
                                else {
                                    toastrErrorAlert("This IMEI may be transfered/ not complete");
                                }
                            }
                            else {
                                toastrErrorAlert("This IMEI may has been transfered/ Invalid");
                            }
                        }

                    }).fail(function (error) {
                        txtIMEIScaning.val('');
                        txtIMEIScaning.focus();
                        toastrErrorAlert("This IMEI may has been transfered/ Invalid");
                        console.log(error);
                })
            }
        }

        function resetFinishGoodsPackagingUI() {
            $("#tblIMEIItem tbody").empty();
            txtIMEIScaning.val('');
            txtCarton.val('');
            txtNetWeight.val('');
            txtIMEIScaning.focus();
        }

        function findDuplication(qrCode) {
            var isValid = true;
            $.each($("#tblIMEIItem tbody tr"), function (index,item) {
                var code = $(this).children("td").eq('5').html();
                if (code == qrCode) {
                    isValid = false;
                }
            })
            return isValid;
        }

        function bindIMEIData(obj) {
            if (!$.isEmptyObject(obj)) {
                var rowNum = $("#tblIMEIItem tbody tr").length;
                var td1 = '<td class="text-center text-bold">'+(rowNum+1)+'</td>';
                var td2 = '<td>' + $.trim(txtIMEIScaning.val()) + '</td>';
                var td3 = '<td>' + obj.ItemName + ' [' + obj.ItemTypeName + '-' + obj.WarehouseName+']' + '</td>';
                var td4 = '<td class="text-center"><a href="#" class="btn btn-sm btn-danger btn-flat data-del-onfly"><i class="fas fa-trash"></i></a></td>';
                var td5 = '<td class="hide">' + obj.IMEI + '</td>';
                var td6 = '<td class="hide">' + obj.CodeNo + '</td>';
                var tr = '<tr>' + td1 + td2 + td3 + td4 + td5 + td6 + '</tr>';
                $("#tblIMEIItem tbody").append(tr);
            }
        }

        function validateCarton() {
            var isValid = true;
            $(".error").addClass("hide");
            if ($("#tblIMEIItem tbody tr").length == 0) {
                $(".empty-data").removeClass('hide');
                isValid = false;
            }
            if (ddlPackagingLinePacking.val() == "") {
                $(".req-pack").removeClass('hide');
                isValid = false;
            }
            if (ddlModelPackaging.val() == "") {
                $(".req-model").removeClass('hide');
                isValid = false;
            }
            if ($.trim(txtCarton.val()) =="") {
                $(".req-carton").removeClass('hide');
                isValid = false;
            }
            //if (TryParseInt(txtQuantity.val(), 0) <= 0) {
            //    $(".req-qty").removeClass('hide');
            //    isValid = false;
            //}
            return isValid; 
        }

        

        $("#btnSaveCarton").click(function (e) {
            e.preventDefault();
            if (validateCarton()) {
                disable("#btnSaveCarton");
                var packaging = ddlPackagingLinePacking.val().split("#");
                var info = { LineId: packaging[1], PackagingLineId: packaging[1], WarehouseId: ddlWarehousePackaging.val(), DescriptionId: ddlModelPackaging.val(), CartoonNo: $.trim(txtCarton.val()), NetWeight: $.trim(txtNetWeight.val()), TotalQty: $("#tblIMEIItem tbody tr").length };

                var details = []; details.length = 0;
                $.each($("#tblIMEIItem tbody tr"), function (index,item) {
                    var tds = $(this).children('td');
                    details.push({
                        IMEI: tds.eq('1').html(),
                        QRCode: tds.eq('5').html(),
                        AllIMEI: tds.eq('4').html()
                    });
                })
                info.FinishGoodsSendToWarehouseDetails = details;

                var data = JSON.stringify({ model: info });

                $.when(postReqWithToken(dataType.applicationJson, dataType.json, type.post, '/Production/SaveFinishGoodsForPacking', data, getToken())).then(function (res, status) {

                    if (status === "success" && res == true) {
                        toastrSuccessAlert(execuStatus.successSave);
                        resetFinishGoodsPackagingUI();
                        LoadFinishGoodsTransferList();
                        LoadDataTableStockInfo();
                    }
                    else {
                        toastrErrorAlert(execuStatus.fail)
                    }
                    enable("#btnSaveCarton");
                }).fail(function (error) {
                    toastrErrorAlert(execuStatus.fail)
                    console.log(error);
                    enable("#btnSaveCarton");
                })
            }
        })
        //================== End of Finish Goods Packaging =================//
    </script>    
}
